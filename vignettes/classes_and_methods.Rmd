---
title: "GenomicTuples: Classes and Methods"
author: "Peter Hickey"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---
  
# Introduction

The `GenomicTuples` package defines general purpose containers for storing _genomic tuples_. It aims to provide functionality for tuples of genomic co-ordinates that are analogous to those available for genomic ranges in the [`GenomicRanges` Bioconductor package](http://www.bioconductor.org/packages/release/bioc/html/GenomicRanges.html).

As you will see, the functionality of the `GenomicTuples` package is based almost entirely on the wonderful `GenomicRanges` package. Therefore, I have tried to keep the user interface as similar as possible.

## What is a genomic tuple?

A genomic tuple is defined by a `seqname`, a `strand` and a `tuple`. All positions in a tuple must be on the same strand and sorted in ascending order. Each tuple has an associated `size`. For example, `chr1:+:{34, 39, 60}` is a 3-tuple (`size` = 3) of the positions `chr1:34`, `chr1:39` and `chr1:60` on the `+` strand.  The `size` of a tuple is an integer, $1, 2, \ldots$. 

When talking about genomic tuples of a general (fixed) `size`, I will abbreviate these to _m-tuples_, where $m$ = `size`. I will refer to the first position as $pos_{1}$/`pos1`, the second as $pos_{2}$/`pos2`, ..., and the final position as $pos_{m}$/`posm`.

The difference between a genomic tuple and a genomic range can be thought of as the difference between a set and an interval. For example, the genomic tuple `chr10:-:{800, 900}` only includes the positions `chr10:-:800` and `chr10:-:900` whereas the genomic range `chr10:-:[800, 900]` includes the positions `chr10:-:800`, `chr10:-:801`, `chr10:-:802`, ..., `chr10:-:900`.

# `GTuples`

The `GTuples` class represents a collection of genomic tuples, where each tuple has the same `size`. These objects can be created by using the `GTuples` constructor function. For example,

```{r, eval = TRUE, echo = FALSE}
library(GenomeInfoDb)
```

```{r, eval = FALSE}
library(GenomicTuples)
```

```{r}
seqinfo <- Seqinfo(paste0("chr", 1:3), c(1000, 2000, 1500), NA, "mock1")
gt3 <- GTuples(seqnames = Rle(c("chr1", "chr2", "chr1", "chr3"),
                              c(1, 3, 2, 4)),
               tuples = matrix(c(1:10, 2:11, 3:12), ncol = 3),
               strand = Rle(strand(c("-", "+", "*", "+", "-")),
                            c(1, 2, 2, 3, 2)),
               score = 1:10, GC = seq(1, 0, length = 10), seqinfo = seqinfo)
names(gt3) <- letters[1:10]
gt3
```

creates a `GTuples` object with 10 genomic tuples. The output of the `GTuples` show method is very similar to that of the show method for `GenomicRanges::GRanges` objects. Namely, it separates the information into a left and right hand region that are separated by `|` symbols. The genomic coordinates (`seqnames`, __`tuples`__, and `strand`) are located on the left-hand side and the metadata columns (annotation) are located on the right. For this example, the metadata is comprised of `score` and `GC` information, but almost anything can be stored in the metadata portion of a `GTuples` object.

The main difference between a `GTuples` and `GenomicRanges::GRanges` that we now have `tuples` rather than `ranges`.

For even more information on the `GTuples` class be sure to consult the manual page.

```{r, eval = FALSE}
?GTuples
```

## Inherited methods

Most methods defined for `GenomicRanges::GRanges` are also applicable to `GTuples`. Those that are not yet defined, which are those that make sense for ranges but generally not for tuples, return error messages. 

If a method that is not defined for `GTuples` but is defined for `GenomicRanges::GRanges` is truly required, then this can be achieved by first coercing the `GTuples` object to a `GenomicRanges::GRanges` object, noting that this is generally a destructive operation:

```{r}
as(gt3, "GRanges")
```

### Basic `GTuples` accessors

The components of the genomic coordinates within a `GTuples` object can be extracted using the `seqnames`, __`tuples`__, and `strand` accessor functions. __The most important difference is that the `tuples` accessor should be used in place of the `ranges` accessor.__  While the `ranges` method is well-defined - namely it accesses $pos_{1}$ and $pos_{m}$ of the object - this is not generally what is required or required.

```{r}
seqnames(gt3)
tuples(gt3)
strand(gt3)
```

Stored annotations for these coordinates can be extracted as a `DataFrame` object using the `mcols` accessor:
```{r}
mcols(gt3)
```

`Seqinfo` can be extracted using the `seqinfo` accessor:
```{r}
seqinfo(gt3)
```

Methods for accessing the length and names have also been defined:
```{r}
length(gt3)
names(gt3)
```

### Splitting and combining `GTuples` objects

`GTuples` objects can be devided into groups using the `split` method. This produces a `GTuplesList` object, a class that will be discussed in detail in the next section.

```{r}
sp <- split(gt3, rep(1:2, each=5))
sp
```

If you then grab the components of this list, they can also be merged by using the `c` and `append` methods.

```{r}
c(sp[[1]], sp[[2]])
```

### Subsetting `GTuples` objects

The expected subsetting operations are also available for `GTuples` objects.

```{r}
gt3[2:3]
```

A second argument to the `[` subset operator can be used to specify which metadata columns to extract from the `GTuples` object. For example,

```{r}
gt3[2:3, "GC"]
```

You can also assign into elements of the `GTuples` object. Here is an example where the 2nd row of a `GTuples` object is replaced with the 1st row of `gt3`.
```{r}
gt3_mod <- gt3
gt3_mod[2] <- gt3[1]
head(gt3_mod, n = 3)
```

There are also methods to repeat, reverse, or select specific portions of `GTuples` objects.

```{r}
rep(gt3[2], times = 3)
rev(gt3)
head(gt3, n = 2)
tail(gt3, n = 2)
window(gt3, start = 2, end = 4)
```

### Basic tuple operations for `GTuples` objects

Basic tuple characteristics of `GTuples` objects can be extracted using the `start`, `end`, and `tuples` methods. __WARNING:__ While the `width` method is well-defined, namely as $pos_{m} - pos_{1} + 1$, this may not be what is required. Instead, please see the `IPD` method that will be discussed in the next section.

```{r}
start(gt3)
end(gt3)
tuples(gt3)
```

#### Intra-tuple operations

Most of the intra-range methods defined for `GenomicRanges::GRanges` objects are not currently defined for `GTuples` objects due to the differences between ranges and tuples. Those not currently defined, and which return an error message, are:

* `narrow`
* `flank`
* `promoters`
* `resize`
* `Ops`

I am happy to add these methods if appropriate, so please contact me if you have suggestions for good definitions. 

Both the `trim` and `shift` methods are well-defined, although the former is somewhat limited since it will return an error if the _internal positions_ exceed the `seqlength`:
```{r}
shift(gt3, 500)
```
```{r, warning = FALSE, error = FALSE}
# Raises warning due to tuple being outside of seqlength
x <- shift(gt3[1], 999)
x

# Returns an error because internal position exceeds sequence length, resulting 
# in a malformed tuple.
trim(x)
```

#### Inter-tuple operations

None of the inter-range methods defined for `GenomicRanges::GRanges` objects are currently defined for `GTuples` objects due to the differences between ranges and tuples. Those not currently defined, and which return an error message, are:

* `range`
* `reduce`
* `gaps`
* `disjoin`
* `isDisjoint`
* `disjointBins`

I am happy to add these methods if appropriate, so please contact me if you have suggestions for good definitions.

## Methods unique to `GTuples`

`GTuples` have a few specifically defined methods that do not exist for `GenomicRanges::GRanges`. These are `tuples`, `size` and `IPD`. 

The `tuples` method we have already seen and is somewhat analagous to the `ranges` method for `GenomicRanges::GRanges`, although returning an integer matrix rather than an `IRanges::IRanges` object:
```{r}
tuples(gt3)
```

The `size` method returns the size of the tuples stored in the object:
```{r}
size(gt3)
```

Every m-tuple with $m \geq 2$ has an associated vector of intra-pair distances ($IPD$). This is defined as $IPD = (pos_{2} - pos_{1}, \ldots, pos_{m} - pos_{m - 1}$. The `IPD` method returns this as an integer matrix:

```{r}
IPD(gt3)
x <- GTuples('chr1', matrix(c(10L, 20L, 50L, 100L), ncol = 4))
IPD(x)
```

## `findOverlaps`-based methods

`findOverlaps`-based methods are discussed in detail in a later section.

## Interval set operations for `GTuples` objects

None of the interval set operations defined for `GenomicRanges::GRanges` objects are currently defined for `GTuples` objects due to the differences between ranges and tuples. Those not currently defined, and which return an error message, are:

* `union`
* `intersect`
* `setdiff`
* `punion`
* `pintersect`
* `psetdiff`

I am happy to add these methods if appropriate, so please contact me if you have suggestions for good definitions. 

## Implementation

While the `GTuple` class can be thought of as a matrix-link object, with the number of columns equal to the `size` of the tuples plus two (one for the `seqname` and one for the `strand`[^ncol]), internally, it extends the `GenomicRanges::GRanges` class. Specifically, the `ranges` slot stores an `IRanges::IRanges` object containing $pos_{1}$ and $pos_{m}$ and, if required, a matrix is used to store the "internal" co-ordinates $pos_{2}, \ldots, pos_{m - 1}$ in the `internalPos` slot. If `size`$\leq 2$ then the `internalPos` slot is set to `NULL`. The `size` is stored as an integer in the `size` slot.

[^ncol]: __WARNING:__ In order to be consistent with how `ncol` is defined for `GRanges` running `ncol(GTuples)` returns `NULL` rather than `size` + 2. Please use `size(GTuples)` to find the `size` of the genomic tuples stored in a `GTuples` instance.

While there are arguments for creating stand-alone `GTuples` and `GTuplesList` classes, by extending the `GRanges` and `GRangesList` classes I get a lot of very useful functionality "for free" via appropriately defined inheritance.

# `GTuplesList`

The `GTuplesList` class is a container to store a `List` of `GTuples` objects. It extends the `GenomicRanges::GRangesList` class. 

Currently, all `GTuples` in a `GTuplesList` must have the same `size`[^size]. I expect that users will mostly use `GTuples` objects and have little need to directly use `GTuplesList` objects.

[^size]: This may be changed in future versions of `GenomicTuples`.

```{r}
seqinfo <- Seqinfo(paste0("chr", 1:3), c(1000, 2000, 1500), NA, "mock1")
gt3 <- GTuples(seqnames = Rle(c("chr1", "chr2", "chr1", "chr3"),
                              c(1, 3, 2, 4)),
               tuples = matrix(c(1:10, 2:11, 3:12), ncol = 3),
               strand = Rle(strand(c("-", "+", "*", "+", "-")),
                            c(1, 2, 2, 3, 2)),
               score = 1:10, GC = seq(1, 0, length = 10), seqinfo = seqinfo)
gtl3 <- GTuplesList(A = gt3[1:5], B = gt3[6:10])
gtl3
```

## Inherited methods

Most methods defined for `GenomicRanges::GRangesList` are also applicable to `GTuplesList`. Those that are not yet defined, which are those that make sense for ranges but generally not for tuples, return error messages. 

If a method that is not defined for `GTuplesList` but is defined for `GenomicRanges::GRangesList` is truly required, then this can be achieved by first coercing the `GTuplesList` object to a `GenomicRanges::GRangesList` object, noting that this is generally a destructive operation:

```{r}
as(gtl3, "GRangesList")
```

### Basic `GTuplesList` accessors

These are very similar to those available for `GTuples` objects, except that they typically return a list since the input is now essentially a list of `GTuples` objects.

```{r}
seqnames(gtl3)
# Returns a list of integer matrices
tuples(gtl3)
tuples(gtl3)[[1]]
strand(gtl3)
```
The `length` and `names` methods will return the length or names of the list:
```{r}
length(gtl3)
names(gtl3)
```

`Seqinfo` can be extracted using the `seqinfo` accessor:
```{r}
seqinfo(gtl3)
```

The `elementLengths` method returns a list of integers corresponding to the result of calling length on each individual `GTuples` object contained by the `GTuplesList`. This is a faster alternative to calling `lapply` on the `GTuplesList`.
```{r}
elementLengths(gtl3)
```

You can also use isEmpty to test if a `GTuplesList` object contains anything:
```{r}
isEmpty(gtl3)
isEmpty(GTuplesList())
```

Finally, in the context of a `GTuplesList` object, the `mcols` method performs a similar operation to what it does on a `GTuples` object. However, this metadata now refers to information at the list level instead of the level of the individual `GTuples` objects:
```{r}
mcols(gtl3) <- c("Transcript A","Transcript B")
mcols(gtl3)
```

### Combining `GTuplesList` objects

`GTuplesList` objects can be unlisted to combine the separate `GTuples` objects that they contain as an
expanded `GTuples`:
```{r}
ul <- unlist(gtl3)
ul
```

You can also append values together useing `append` or `c`.

### Basic tuple operations for `GTuplesList` objects

Basic tuple characteristics of `GTuplesList` objects can be extracted using the `start`, `end`, and `tuples` methods. These are very similar to those available for `GTuples` objects, except that they typically return a list since the input is now essentially a list of `GTuples` objects.

__WARNING:__ While the `width` method is well-defined, namely as an `IntegerList` of $pos_{m} - pos_{1} + 1$, this may not be what is required. Instead, please see the `IPD` method that will be discussed in the next section.

```{r}
start(gtl3)
end(gtl3)
tuples(gtl3)
```

#### Intra-tuple operations

Most of the intra-range methods defined for `GenomicRanges::GRangesList` objects are not currently defined for `GTuples` objects due to the differences between ranges and tuples. Those not currently defined, and which return an error message, are:

* `flank`
* `promoters`
* `resize`
* `restrict`

I am happy to add these methods if appropriate, so please contact me if you have suggestions for good definitions. 

The`shift` method is well-defined:
```{r}
shift(gtl3, 500)
shift(gtl3, IntegerList(A = 300L, B = 500L))
```

#### Inter-tuple operations

None of the inter-range methods defined for `GenomicRanges::GRangesList` objects are currently defined for `GTuplesList` objects due to the differences between ranges and tuples. Those not currently defined, and which return an error message, are:

* `range`
* `reduce`
* `disjoin`
* `isDisjoint`

I am happy to add these methods if appropriate, so please contact me if you have suggestions for good definitions. 

## Methods unique to `GTuplesList`

Like `GTuples`, `GTuplesList` have a few specifically defined methods that do not exist for `GenomicRanges::GRangesList`. These are `tuples`, `size` and `IPD`. These are identical to the methods for `GTuples`, except that they typically return a list since the input is now essentially a list of `GTuples` objects.

```{r}
tuples(gtl3)
tuples(gtl3)[[1]]
size(gtl3)
IPD(gtl3)
IPD(gtl3)[[1]]
```

## `findOverlaps`-based methods

`findOverlaps`-based methods are discussed in detail in a later section.

## Interval set operations for `GTuplesList` objects

None of the interval set operations defined for `GenomicRanges::GRangesList` objects are currently defined for `GTuplesList` objects due to the differences between ranges and tuples. Those not currently defined, and which return an error message, are:

* `punion`
* `pintersect`
* `psetdiff`

I am happy to add these methods if appropriate, so please contact me if you have suggestions for good definitions. 

### Subsetting `GTuplesList` objects

Subsetting of `GTuplesList` objects is identical to subsetting of `GenomicRanges::GRangesList` objects:
```{r}
gtl3[1]
gtl3[[1]]
gtl3["A"]
gtl3$B
```

When subsetting a `GTuplesList`, you can also pass in a second parameter (as with a `GTuples` object) to again specify which of the metadata columns you wish to select:
```{r}
gtl3[1, "score"]
gtl3["B", "GC"]
```

The `head`, `tail`, `rep`, `rev`, and `window` methods all behave as you would expect them to for a list object. For example, the elements referred to by `window` are now list elements instead of `GTuples` elements:
```{r}
rep(gtl3[[1]], times = 3)
rev(gtl3)
head(gtl3, n = 1)
tail(gtl3, n = 1)
window(gtl3, start = 1, end = 1)
```


## Looping over GRangesList objects

__TODO: UP TO HERE__


### Implementation

# `findOverlaps`-based methods

# Session info

